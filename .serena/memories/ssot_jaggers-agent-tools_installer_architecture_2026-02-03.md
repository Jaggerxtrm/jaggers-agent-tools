---
title: "Installer and Sync Architecture"
version: 1.4.0
created: 2026-02-03
updated: 2026-02-25
scope: jaggers-config-manager
category: ssot
subcategory: installer
domain: [infrastructure, cli, sync, gemini, claude, npx]
tracks:
  - "cli/**"
  - "config/**"
status: active
changelog:
  - version: 1.0.0
    date: 2026-01-31
    changes: Initial implementation of the Config Manager CLI.
  - version: 1.1.0
    date: 2026-02-03
    changes: Added zero-cloning support, Gemini command sync, and auto-generation.
  - version: 1.1.1
    date: 2026-02-03
    changes: Implemented dynamic path resolution in sync logic to fix hardcoded paths in settings.json.
  - version: 1.4.0
    date: 2026-02-25
    changes: Unified 3-phase sync flow. New core/preflight.ts and core/interactive-plan.ts. sync.ts rewritten to run preflight → multiselect plan → execute. add-optional.ts deprecated (redirects to sync). Optional server auto-install moved into sync phase 3.
  - version: 1.3.0
    date: 2026-02-25
    changes: GitNexus integration. add-optional.ts supports _notes.install_cmd (auto-installs npm packages with ora spinner) and _notes.post_install_message (post-sync guidance banner). Hook and skills now synced via standard pipeline.
  - version: 1.2.0
    date: 2026-02-21
    changes: Full TypeScript migration. Commander.js sub-commands (sync/status/reset). Adapter pattern. Rollback protection. Zod schemas. Windows compatibility baked in.
---

<!-- INDEX: auto-generated by validate_metadata.py — do not edit manually -->
| Section | Summary |
|---|---|
| [Overview](#overview) | The Jaggers Agent Tools installer (`jaggers-config-manager`) is a Node |
| [Distribution Models](#distribution-models) | The suite is distributed as a self-installing package via `npx` |
| [Architecture (v1.2.0 — TypeScript)](#architecture-v1.2.0-—-typescript) | The CLI is now a fully typed TypeScript package compiled with `tsup` |
| [Standards & Best Practices](#standards-&-best-practices) | 1 |
| [3-Phase Unified Sync Flow (v1.4.0)](#3-phase-unified-sync-flow-v1.4.0) | `cli/src/commands/sync |
| [Related Documentation](#related-documentation) | _no summary_ |
<!-- END INDEX -->



# Installer and Sync Architecture - SSOT

## Overview

The Jaggers Agent Tools installer (`jaggers-config-manager`) is a Node.js-based CLI designed to synchronize skills, hooks, and configuration across multiple agent environments (Claude Code and Gemini CLI).

## Distribution Models

### 1. Zero-Cloning (Primary Method)
The suite is distributed as a self-installing package via `npx`. This ensures that all users receive the latest skills, hooks, and commands without manual repository management.
- **Command**: `npx -y github:Jaggerxtrm/jaggers-agent-tools`
- **Mechanism**: `npm` fetches the repository, installs dependencies in a temporary cache, and executes the `bin` entry point defined in the root `package.json`.

### 2. Local Development Sync
Used for developing new tools or manual synchronization of a cloned repository.
- **Command**: `npx ./cli`

## Architecture (v1.2.0 — TypeScript)

The CLI is now a fully typed TypeScript package compiled with `tsup`. Entry: `cli/dist/index.js`.

### Sub-commands (Commander.js)
- `jaggers-config sync [--dry-run] [-y] [--prune] [--backport]` — 3-phase unified sync (see below)
- `jaggers-config status` — read-only diff
- `jaggers-config reset` — clear saved preferences
- `jaggers-config add-optional` — **deprecated**, redirects to `jaggers-config sync`

### Adapter Pattern (`cli/src/adapters/`)
- `ToolAdapter` abstract base class
- `ClaudeAdapter`, `GeminiAdapter`, `QwenAdapter` implementations
- `detectAdapter(systemRoot)` factory with Windows path normalization

### Core Modules (`cli/src/core/`)
- `context.ts` — environment detection and target selection
- `diff.ts` — MD5-based changeset calculation (missing/outdated/drifted)
- `preflight.ts` — **new** parallel `Promise.all` checks across all targets; returns `PreflightPlan` with `TargetPlan[]`, `OptionalServerItem[]`
- `interactive-plan.ts` — **new** `prompts` multiselect UI; drifted pre-unchecked, optionals pre-unchecked; returns `SelectedPlan | null`
- `sync-executor.ts` — file copy/symlink with rollback protection; accepts `selectedMcpServers?: string[]` (optional server names pre-selected upstream)
- `manifest.ts` — `.jaggers-sync-manifest.json` read/write
- `rollback.ts` — backup/restore for atomic operations

### Utils (`cli/src/utils/`)
- `hash.ts` — MD5 file/directory hashing
- `atomic-config.ts` — deep merge with protected key preservation
- `config-adapter.ts` — cross-agent format transforms + Windows path fix
- `env-manager.ts` — `~/.config/jaggers-agent-tools/.env` management
- `sync-mcp-cli.ts` — native `mcp add/remove` via agent CLIs
- `transform-gemini.ts` — SKILL.md → Gemini `.toml` command generation

### Type Definitions (`cli/src/types/`)
- `config.ts` — Zod schemas: `SyncMode`, `ChangeSet`, `Manifest`
- `models.ts` — shared interfaces: `Skill`, `Hook`, `MCPServer`

## Standards & Best Practices

1. **Safety First**: Always creates backups (`.bak`) of configuration files before overwriting.
2. **Platform Neutrality**: Uses forward slashes and cross-platform path resolution for Windows/Linux/macOS compatibility.
3. **Transparency**: Explicitly displays a breakdown of `[+] Missing`, `[^] Outdated`, and `[<] Drifted` items before execution.

## 3-Phase Unified Sync Flow (v1.4.0)

`cli/src/commands/sync.ts` is the single entry point for all sync operations. Optional servers are now part of the main sync flow (not a separate command).

### Phase 1: Preflight (`core/preflight.ts`)
`runPreflight(repoRoot, prune)` runs all checks in parallel via `Promise.all`:
- Detects which target dirs exist (`~/.claude`, `~/.gemini`, `~/.qwen`, `~/.gemini/antigravity`)
- Calculates file diff (missing/outdated/drifted) per target
- Checks which core MCP servers are installed per agent
- Loads optional servers not yet installed
Returns `PreflightPlan` with `syncMode` set to `'prune'` if `--prune` passed, else `'copy'`.

### Phase 2: Interactive Plan (`core/interactive-plan.ts`)
`interactivePlan(plan, { dryRun, yes })` presents a single `prompts` multiselect:
- `[+]` missing items — pre-checked
- `[↑]` outdated items — pre-checked
- `[~]` drifted items — **pre-unchecked** (local edits preserved by default)
- `[?]` optional servers — **pre-unchecked** (opt-in)
- `--dry-run`: displays plan without prompting, returns null
- `--yes`/`-y`: auto-applies defaults without prompting

### Phase 3: Execute (ordered)
1. **Prerequisite installs**: `execSync(installCmd)` with `ora` spinner for each selected optional server
2. **File sync**: `executeSync()` per target with partial ChangeSet (only selected items)
3. **MCP sync**: `syncMcpServersWithCli()` via `executeSync`, merging selected optionals into core config
4. **Post-install messages**: yellow "⚠️ Next Steps Required" banner

**Metadata fields** in `config/mcp_servers_optional.json → _notes`:
- `install_cmd`: shell command run before MCP add (e.g. `npm install -g gitnexus`)
- `post_install_message`: displayed after sync

**Current servers with auto-install:** `gitnexus` (`npm install -g gitnexus`)

## Related Documentation

- `ssot_jaggers-agent-tools_documenting_workflow_2026-02-03.md` - Documentation standards.
- `ssot_jaggers-agent-tools_orchestrating_agents_2026-02-03.md` - Orchestration skill architecture.
- `ssot_cli_mcp_servers_2026-02-21.md` - MCP servers configuration and sync.
