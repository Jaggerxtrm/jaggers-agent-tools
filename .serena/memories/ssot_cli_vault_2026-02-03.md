---
title: CLI Vault Sync Architecture
version: 1.0.0
updated: 2026-02-03
domain: cli
tracks:
  - "config/settings.json"
  - "cli/src/**/*vault*"
scope: cli-vault
category: ssot
changelog:
  - 1.0.0: Initial documentation of the Vault Sync system for non-destructive configuration management.
---

<!-- INDEX: auto-generated by validate_metadata.py â€” do not edit manually -->
| Section | Summary |
|---|---|
| [Core Principles](#core-principles) | 1 |
| [Implementation Details](#implementation-details) | The following keys (and their children) are protected in `settings |
| [Key Files](#key-files) | When adding new configuration blocks to `settings |
| [Maintenance](#maintenance) | When adding new configuration blocks to `settings |
<!-- END INDEX -->



# CLI Vault Sync Architecture

The Vault Sync system ensures that local-only configurations (secrets, API keys, custom MCP servers) are preserved during synchronization with the central repository.

## Core Principles

1. **Non-Destructive**: Never overwrite keys marked as "Protected" if they exist locally.
2. **Atomic**: Use temporary files and atomic renames to prevent corruption.
3. **Hybrid Merge**: Support merging of complex objects (like `mcpServers`) where individual entries are protected but new ones can be added.

## Implementation Details

### Protected Keys
The following keys (and their children) are protected in `settings.json`:
- `security`: OAuth data, personal auth tokens.
- `mcpServers`: Individually protected entries (merges new servers, keeps local config for existing ones).
- `hooks`: Both Claude and Gemini hook definitions.
- `permissions`: User-defined tool permissions.
- `general`: UI and feature preferences.
- `model`: Preferred model selection.

### Atomic Write Workflow
To ensure data integrity, especially for files containing secrets:
1. Load `local` and `repo` configs.
2. Perform `deepMergeWithProtection`.
3. Write to `.settings.json.tmp.[timestamp]`.
4. Validate JSON integrity of the temp file.
5. Atomic `fs.rename` to `settings.json`.

### Dry Run Mode
The CLI supports a `--dry-run` flag which:
- Performs the full merge in memory.
- Logs exactly which local keys were preserved in the "Vault".
- Logs which new keys would be added.
- Skips the physical write operation.

## Key Files
- `cli/lib/atomic-config.js`: Contains the merge logic and atomic write utilities.
- `cli/lib/sync.js`: Integrates the Vault pattern into the main sync pipeline.
- `cli/index.js`: Exposes the `--dry-run` flag to the user.

## Maintenance
When adding new configuration blocks to `settings.json` that may contain user secrets, they MUST be added to the `PROTECTED_KEYS` array in `cli/lib/atomic-config.js`.