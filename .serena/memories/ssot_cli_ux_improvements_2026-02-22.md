---
title: CLI UX Improvements ‚Äî Vsyc-Inspired Enhancements
version: 2.0.0
updated: 2026-02-25
domain: cli
tracks:
  - "cli/src/commands/**"
  - "cli/src/core/**"
type: ssot
tags: [cli, ux, sync, status, error-handling, spinners]
changelog:
  - version: 2.0.0
    date: 2026-02-25
    description: Unified 3-phase sync flow (improvement 11). Preflight runs all checks in parallel. Single prompts multiselect replaces per-target confirm. add-optional deprecated. Drifted/optionals pre-unchecked. Optional server auto-install moved into sync Phase 3.
  - version: 1.1.0
    date: 2026-02-25
    description: add-optional.ts enhanced with prerequisite install spinner and post-install guidance banner (improvement 10)
  - version: 1.0.0
    date: 2026-02-22
    description: Initial implementation of 9 UX improvements inspired by vsync patterns
---

<!-- INDEX: auto-generated by validate_metadata.py ‚Äî do not edit manually -->
| Section | Summary |
|---|---|
| [Overview](#overview) | This SSOT documents the comprehensive UX improvements implemented in the Jaggers Config CLI, inspired by the vsync proje |
| [Critical Safety Improvements](#critical-safety-improvements) | **Problem:** If reading the target fails in prune mode, the diff would return `[]`, causing prune to delete everything |
| [UX Feedback & Polish](#ux-feedback-&-polish) | **Problem:** MCP CLI commands take 2-10s with no feedback |
| [Files Modified](#files-modified) | **Build Verification:** |
| [Testing](#testing) | **Build Verification:** |
| [Related Documentation](#related-documentation) | _no summary_ |
<!-- END INDEX -->



# CLI UX Improvements ‚Äî Vsyc-Inspired Enhancements

## Overview

This SSOT documents the comprehensive UX improvements implemented in the Jaggers Config CLI, inspired by the vsync project's patterns. These enhancements focus on **safety**, **feedback**, and **polish**.

**Implementation Date:** 2026-02-22
**Files Modified:** 6 core files
**New Dependencies:** `ora` (spinners)

---

## Critical Safety Improvements

### 1. Prune Mode Read-Failure Guard

**Problem:** If reading the target fails in prune mode, the diff would return `[]`, causing prune to delete everything.

**Solution:** Added `PruneModeReadError` that aborts sync immediately if a system-side hash read fails.

**Implementation:**
```typescript
// cli/src/core/diff.ts
export class PruneModeReadError extends Error {
    constructor(path: string) {
        super(`Cannot read ${path} in prune mode ‚Äî aborting to prevent accidental deletion`);
        this.name = 'PruneModeReadError';
    }
}

async function compareItem(..., pruneMode: boolean = false) {
    try {
        systemHash = await hashDirectory(systemPath);
    } catch (error) {
        if (pruneMode) {
            throw new PruneModeReadError(systemPath);
        }
        cat.missing.push(item);
        return;
    }
}
```

**Usage:**
```bash
jaggers-config sync --prune  # Now safe from accidental mass deletion
```

---

### 2. Dynamic Repo Root Detection

**Problem:** `repoRoot` was hardcoded as `path.resolve(process.cwd(), '..')`, which failed when running from outside `cli/`.

**Solution:** Created `findRepoRoot()` utility that walks up the directory tree looking for marker files.

**Implementation:**
```typescript
// cli/src/utils/repo-root.ts
export async function findRepoRoot(startDir: string = process.cwd()): Promise<string> {
    let dir = path.resolve(startDir);
    while (true) {
        const skillsPath = path.join(dir, 'skills');
        const hooksPath = path.join(dir, 'hooks');
        if (await fs.pathExists(skillsPath) && await fs.pathExists(hooksPath)) {
            return dir;
        }
        const parent = path.dirname(dir);
        if (parent === dir) {
            throw new Error('Could not locate jaggers-agent-tools repo root...');
        }
        dir = parent;
    }
}
```

**Usage:**
```bash
# Now works from any directory within the repo
cd ~/projects/jaggers-agent-tools && jaggers-config sync
cd ~/projects/jaggers-agent-tools/cli && jaggers-config sync
cd ~/projects/jaggers-agent-tools/docs && jaggers-config sync
```

---

### 3. Single Confirmation Prompt

**Problem:** Users were prompted once per target (4 targets = 4 prompts).

**Solution:** Collect all changesets first, display the full plan, then ask once.

**Implementation:**
```typescript
// cli/src/commands/sync.ts
// 1. Collect all changesets
const allChanges: TargetChanges[] = [];
for (const target of targets) {
    const changeSet = await calculateDiff(repoRoot, target, prune);
    allChanges.push({ target, changeSet, totalChanges, skippedDrifted: [] });
}

// 2. Display full plan
console.log(kleur.bold('\nüìã Sync Plan:'));
for (const { target, changeSet, totalChanges } of allChanges) {
    console.log(kleur.bold(`\nüìÇ ${path.basename(target)} ‚Üí ${totalChanges} changes`));
    // ... show categories
}

// 3. Ask once
const totalChangesCount = allChanges.reduce((sum, c) => sum + c.totalChanges, 0);
const { confirm } = await prompts({
    message: `Proceed with ${actionType} (${totalChangesCount} total changes)?`
});
```

**Before:**
```
üìÇ Target: .claude
Proceed with sync (2 changes)? [Y/n]

üìÇ Target: .gemini
Proceed with sync (3 changes)? [Y/n]

üìÇ Target: .qwen
Proceed with sync (1 change)? [Y/n]
```

**After:**
```
üìã Sync Plan:

üìÇ .claude ‚Üí 2 changes
  + 2 missing skills: skill-creator, documenting
üìÇ .gemini ‚Üí 3 changes
  ‚Üë 3 outdated hooks: skill-suggestion, pip-venv-guard, serena-reminder
üìÇ .qwen ‚Üí 1 change
  ‚úó 1 drifted commands: search

Proceed with sync (6 total changes)? [Y/n]
```

---

## UX Feedback & Polish

### 4. Ora Spinners for Slow Operations

**Problem:** MCP CLI commands take 2-10s with no feedback.

**Solution:** Added `ora` spinners to all async operations.

**Implementation:**
```typescript
// cli/src/commands/sync.ts
const ctxSpinner = ora('Detecting environments‚Ä¶').start();
const ctx = await getContext();
ctxSpinner.succeed('Config loaded');

const diffSpinner = ora(`Calculating diff for ${path.basename(target)}‚Ä¶`).start();
const changeSet = await calculateDiff(repoRoot, target, prune);
diffSpinner.succeed('Plan generated');

const syncSpinner = ora('Syncing‚Ä¶').start();
const count = await executeSync(repoRoot, target, changeSet, syncMode, actionType, dryRun);
syncSpinner.succeed(`Synced ${count} items`);
```

**Visual Feedback:**
```
- Detecting environments‚Ä¶
‚úî Config loaded

- Calculating diff for .claude‚Ä¶
‚úî Plan generated

- Syncing‚Ä¶
‚úî Synced 2 items
```

---

### 5. Enhanced Status Output

**Problem:** `status` showed flat diff list with no summary, timestamps, or health indicators.

**Solution:** Added last sync time, item counts, health indicators, and actionable hints.

**Implementation:**
```typescript
// cli/src/commands/status.ts
function formatRelativeTime(timestamp: number): string {
    const diff = Date.now() - timestamp;
    const hours = Math.floor(diff / 3600000);
    const days = Math.floor(diff / 86400000);
    if (hours < 24) return `${hours} hour${hours > 1 ? 's' : ''} ago`;
    return `${days} day${days > 1 ? 's' : ''} ago`;
}

// Load manifest for metadata
const manifestPath = getManifestPath(target);
if (await fs.pathExists(manifestPath)) {
    const manifest = await fs.readJson(manifestPath);
    console.log(kleur.gray(`  Last synced: ${formatRelativeTime(manifest.lastSync)}`));
    console.log(kleur.gray(`  Manifest: ${manifest.skills} skills, ${manifest.hooks} hooks`));
}

// Show health indicator
if (!hasChanges) {
    console.log(kleur.green('  ‚úì Up-to-date'));
} else {
    console.log(kleur.yellow(`\n  ‚ö† Pending changes: ${totalChanges}`));
}
```

**Output Example:**
```
- Loading status‚Ä¶
‚úî Status loaded

üìÇ .claude
  Last synced: 3 hours ago
  Manifest: 5 skills, 4 hooks
  ‚úì Up-to-date

üìÇ .gemini
  Last synced: 5 hours ago
  Manifest: 5 skills, 4 hooks
  + 2 missing skills
  ‚Üë 1 outdated hooks
  
  ‚ö† Pending changes: 3

üí° Run `jaggers-config sync` to apply changes
```

---

### 6. Global Error Handler

**Problem:** Unhandled errors printed raw stack traces with internal paths.

**Solution:** Added global error handlers for clean error messages.

**Implementation:**
```typescript
// cli/src/index.ts
program.exitOverride((err) => {
    if (err.code === 'commander.unknownCommand') {
        console.error(kleur.red(`\n‚úó Unknown command. Run 'jaggers-config --help'\n`));
        process.exit(1);
    }
});

process.on('uncaughtException', (err) => {
    if ((err as any).code?.startsWith('commander.')) return;
    console.error(kleur.red(`\n‚úó ${err.message}\n`));
    process.exit(1);
});

process.on('unhandledRejection', (reason) => {
    console.error(kleur.red(`\n‚úó ${String(reason)}\n`));
    process.exit(1);
});
```

**Before:**
```
Error: ENOENT: no such file or directory, access '/home/user/project/skills'
    at Object.accessSync (node:fs:254:3)
    at findRepoRoot (/home/dawid/projects/jaggers-agent-tools/cli/src/utils/repo-root.ts:10:8)
    ...
```

**After:**
```
‚úó Could not locate jaggers-agent-tools repo root. Run from within the cloned repository.
```

---

### 7. Dry-Run Banner Positioning

**Problem:** Dry-run banner printed before target selection, causing confusion.

**Solution:** Moved notice to display after the full plan is shown.

**Before:**
```
  DRY RUN ‚Äî no changes will be written

? Select target environments: ‚Ä∫
```

**After:**
```
üìã Sync Plan:

üìÇ .claude ‚Üí 2 changes
üìÇ .gemini ‚Üí 1 change

üí° Dry run ‚Äî no changes written

Proceed with sync (3 total changes)? [Y/n]
```

---

### 8. Drifted Items Feedback

**Problem:** Drifted items were silently skipped during sync with no feedback.

**Solution:** Report skipped drifted items after sync completes.

**Implementation:**
```typescript
// cli/src/commands/sync.ts
// Track skipped drifted items
for (const [category, cat] of Object.entries(changeSet)) {
    const c = cat as any;
    if (c.drifted.length > 0 && actionType === 'sync') {
        skippedDrifted.push(...c.drifted.map((item: string) => `${category}/${item}`));
    }
}

// Report after sync
const allSkipped = allChanges.flatMap(c => c.skippedDrifted);
if (allSkipped.length > 0 && actionType === 'sync' && !dryRun) {
    console.log(kleur.yellow(`\n  ‚ö† ${allSkipped.length} drifted item(s) skipped (local edits preserved):`));
    for (const item of allSkipped) {
        console.log(kleur.yellow(`      ${item}`));
    }
    console.log(kleur.yellow(`  Run 'jaggers-config sync --backport' to push them back.\n`));
}
```

**Output:**
```
‚úî Synced 5 items

  ‚ö† 2 drifted item(s) skipped (local edits preserved):
      hooks/skill-suggestion
      hooks/pip-venv-guard
  Run 'jaggers-config sync --backport' to push them back.
```

---

### 9. Ignored Items Filtering

**Problem:** `__pycache__` and other build artifacts appeared in diff output.

**Solution:** Added `IGNORED_ITEMS` set to filter before scanning.

**Implementation:**
```typescript
// cli/src/core/diff.ts
const IGNORED_ITEMS = new Set([
    '__pycache__',
    '.DS_Store',
    'Thumbs.db',
    '.gitkeep',
    'node_modules'
]);

const items = (await fs.readdir(repoPath)).filter(i => !IGNORED_ITEMS.has(i));
```

**Before:**
```
‚úó 1 drifted hooks: __pycache__
```

**After:**
```
‚úì Up-to-date
```

---

## Files Modified

| File | Changes |
|------|---------|
| `cli/src/core/diff.ts` | Added `PruneModeReadError`, `IGNORED_ITEMS`, prune mode param |
| `cli/src/utils/repo-root.ts` | New utility for dynamic repo root detection |
| `cli/src/commands/sync.ts` | **v2**: full 3-phase rewrite (preflight ‚Üí multiselect ‚Üí execute) |
| `cli/src/commands/status.ts` | Enhanced output with timestamps, counts, health |
| `cli/src/commands/add-optional.ts` | **deprecated** ‚Äî prints redirect to `jaggers-config sync` |
| `cli/src/core/manifest.ts` | Added `getManifestPath()` helper |
| `cli/src/core/preflight.ts` | **new** ‚Äî parallel preflight checks, PreflightPlan types |
| `cli/src/core/interactive-plan.ts` | **new** ‚Äî prompts multiselect, SelectedPlan types |
| `cli/src/core/sync-executor.ts` | Removed inline optional prompt; added `selectedMcpServers?` param |
| `cli/src/utils/sync-mcp-cli.ts` | Exported `getCurrentServers`, `AgentName` |
| `cli/src/index.ts` | Global error handlers |
| `cli/package.json` | Added `ora` dependency |

---

## Testing

**Build Verification:**
```bash
cd cli && npm run build  # ‚úì Success
cd cli && npm run typecheck  # ‚úì No errors
```

**CLI Commands:**
```bash
jaggers-config --help  # ‚úì Clean output
jaggers-config status  # ‚úì Enhanced output with spinners
jaggers-config sync --dry-run  # ‚úì Single prompt, proper banner positioning
```

---

### 10. Optional Server Prerequisite Install (add-optional.ts)

**Problem:** Selecting an optional MCP server that required a global npm package gave no feedback and could silently fail.

**Solution:** `add-optional.ts` now reads `_notes.install_cmd` from each selected server in `mcp_servers_optional.json`. If present, runs it via `execSync` with an `ora` spinner before MCP sync, then prints `_notes.post_install_message` under a yellow "‚ö†Ô∏è Next Steps Required" banner after all targets are synced.

**Visual Feedback:**
```
  Selected: gitnexus

‚†∏ Installing prerequisite: npm install -g gitnexus
‚úî Installed: npm install -g gitnexus

üìÇ Target: .claude
  ‚úì gitnexus (added)

‚úì Optional MCP servers added successfully

‚ö†Ô∏è  Next Steps Required:

[gitnexus]
  ‚ö° GitNexus must be indexed per project!
     Run inside each project you want to use it with:

       npx gitnexus analyze
```

---

### 11. Unified 3-Phase Sync Flow

**Problem:** The sync flow had multiple UX pain points:
- Optional server prompts appeared mid-flow, once per target
- No upfront visibility into what will change across all targets
- `add-optional` was a separate command users had to discover
- Drifted items were silently skipped with no opt-in choice

**Solution:** Rewrote `sync.ts` with a 3-phase architecture. Merged `add-optional` into main sync.

**Phase 1 ‚Äî Parallel Preflight:** Single spinner runs all checks concurrently:
```
‚úî Ready ‚Äî 27 potential change(s) across 4 target(s)
```

**Phase 2 ‚Äî Single Multiselect Plan:** All items presented in one `prompts` multiselect:
```
üìã Sync Plan  (space to toggle, a = all, enter to confirm)

  ‚îÄ‚îÄ .claude files ‚îÄ‚îÄ
  ‚óâ [+] config/settings.json
  ‚îÄ‚îÄ .claude MCP servers ‚îÄ‚îÄ
  ‚óâ [+] serena
  ‚îÄ‚îÄ optional servers ‚îÄ‚îÄ
  ‚óØ [?] gitnexus ‚ö† Requires npm install -g gitnexus
```
- `[~]` drifted items default to `‚óØ` (skip recommended)
- `[?]` optional servers default to `‚óØ` (opt-in)
- `--yes`/`-y`: auto-applies defaults, no prompt
- `--dry-run`: displays plan, no changes written

**Phase 3 ‚Äî Ordered Execution:** prerequisite installs ‚Üí file sync ‚Üí MCP sync ‚Üí post-install messages.

**Files Modified:**
- `cli/src/core/preflight.ts` ‚Äî new file
- `cli/src/core/interactive-plan.ts` ‚Äî new file
- `cli/src/core/sync-executor.ts` ‚Äî removed inline prompt, added `selectedMcpServers?` param
- `cli/src/commands/sync.ts` ‚Äî full rewrite
- `cli/src/commands/add-optional.ts` ‚Äî deprecated (prints redirect notice)
- `cli/src/utils/sync-mcp-cli.ts` ‚Äî exported `getCurrentServers`, `AgentName`

---

## Related Documentation

- [CLI UX Improvements Plan](../../docs/plans/cli-ux-improvements.md)
- [Universal Configuration Hub SSOT](ssot_cli_universal_hub_2026-02-19.md)
- [MCP Servers Configuration SSOT](ssot_cli_mcp_servers_2026-02-21.md)
